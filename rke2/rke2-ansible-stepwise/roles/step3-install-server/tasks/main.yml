---
# Step 3: 安装 RKE2 Server (本地文件安装)
- name: 创建 RKE2 配置目录
  file:
    path: "{{ rke2_config_dir }}"
    state: directory
    mode: '0755'

- name: 生成 RKE2 Server 配置
  copy:
    dest: "{{ rke2_config_dir }}/config.yaml"
    content: |
      write-kubeconfig-mode: "0644"
      tls-san:
        - "{{ ansible_host }}"
        - "{{ inventory_hostname }}"
        - "127.0.0.1"
      cluster-cidr: "{{ cluster_cidr }}"
      service-cidr: "{{ service_cidr }}"
      cluster-dns: "{{ cluster_dns }}"
      cni: "{{ rke2_cni }}"
      token: "{{ rke2_token }}"
      disable:
        - rke2-ingress-nginx
      node-label:
        - "node-role.kubernetes.io/control-plane=true"
      node-taint:
        - "node-role.kubernetes.io/control-plane=true:NoSchedule"
      selinux: false
    mode: '0600'

- name: 创建镜像加速配置
  copy:
    dest: "{{ rke2_config_dir }}/registries.yaml"
    content: |
      mirrors:
        docker.io:
          endpoint:
            - "https://docker.1ms.run"
            - "https://docker.m.daocloud.io"
            - "https://docker.nju.edu.cn"
        registry.k8s.io:
          endpoint:
            - "https://k8s.m.daocloud.io"
        ghcr.io:
          endpoint:
            - "https://ghcr.m.daocloud.io"
        quay.io:
          endpoint:
            - "https://quay.m.daocloud.io"
    mode: '0644'

- name: 检查 RKE2 是否已安装
  stat:
    path: /usr/local/bin/rke2
  register: rke2_installed

- name: 检查安装文件是否存在
  stat:
    path: /tmp/rke2.linux-amd64.tar.gz
  register: rke2_tarball

- name: 提示上传文件
  fail:
    msg: |
      请先上传 RKE2 安装文件到 /tmp/ 目录：
      scp rke2.linux-amd64.tar.gz caiqian@{{ ansible_host }}:/tmp/
      scp rke2-images.linux-amd64.tar.zst caiqian@{{ ansible_host }}:/tmp/
  when: not rke2_installed.stat.exists and not rke2_tarball.stat.exists

- name: 解压 RKE2 二进制文件
  unarchive:
    src: /tmp/rke2.linux-amd64.tar.gz
    dest: /usr/local
    remote_src: yes
  when: not rke2_installed.stat.exists

- name: 创建镜像目录
  file:
    path: /var/lib/rancher/rke2/agent/images
    state: directory
    mode: '0755'
  when: not rke2_installed.stat.exists

- name: 复制镜像文件
  copy:
    src: /tmp/rke2-images.linux-amd64.tar.zst
    dest: /var/lib/rancher/rke2/agent/images/
    remote_src: yes
  when: not rke2_installed.stat.exists

- name: 创建 systemd 服务文件
  copy:
    dest: /etc/systemd/system/rke2-server.service
    content: |
      [Unit]
      Description=Rancher Kubernetes Engine v2 (server)
      Documentation=https://github.com/rancher/rke2#readme
      Wants=network-online.target
      After=network-online.target
      
      [Service]
      Type=notify
      EnvironmentFile=-/etc/default/rke2-server
      EnvironmentFile=-/etc/sysconfig/rke2-server
      KillMode=process
      Delegate=yes
      LimitNOFILE=1048576
      LimitNPROC=infinity
      LimitCORE=infinity
      TasksMax=infinity
      TimeoutStartSec=0
      Restart=always
      RestartSec=5s
      ExecStartPre=/bin/sh -xc '! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.service'
      ExecStartPre=-/sbin/modprobe br_netfilter
      ExecStartPre=-/sbin/modprobe overlay
      ExecStart=/usr/local/bin/rke2 server
      
      [Install]
      WantedBy=multi-user.target
    mode: '0644'

- name: 启用 rke2-server 服务
  systemd:
    name: rke2-server
    enabled: yes
    daemon_reload: yes

- name: 启动 rke2-server 服务
  systemd:
    name: rke2-server
    state: started

- name: 等待 RKE2 API 就绪
  wait_for:
    port: 6443
    delay: 10
    timeout: 300

- name: 创建 kubectl 符号链接
  file:
    src: /var/lib/rancher/rke2/bin/kubectl
    dest: /usr/local/bin/kubectl
    state: link

- name: 配置环境变量
  copy:
    dest: /etc/profile.d/rke2.sh
    content: |
      export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
      export PATH=$PATH:/var/lib/rancher/rke2/bin
    mode: '0644'

- name: 等待 node-token 生成
  wait_for:
    path: /var/lib/rancher/rke2/server/node-token
    timeout: 60

- name: 获取 node-token
  slurp:
    src: /var/lib/rancher/rke2/server/node-token
  register: node_token

- name: 保存 token 到本地
  set_fact:
    rke2_node_token: "{{ node_token.content | b64decode | trim }}"
  delegate_to: localhost
  delegate_facts: yes
  run_once: yes

- name: 验证 Server 安装
  shell: |
    /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml get nodes
  register: server_status
  changed_when: false
  retries: 5
  delay: 10

- name: 显示 Server 状态
  debug:
    msg: "{{ server_status.stdout_lines }}"

- name: Step 3 完成提示
  debug:
    msg: |
      ✓ Step 3 完成 - RKE2 Server 安装成功
      Token: {{ hostvars['localhost']['rke2_node_token'] }}
