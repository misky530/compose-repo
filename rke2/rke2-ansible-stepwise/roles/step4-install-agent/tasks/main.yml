---
# Step 4: 安装 RKE2 Agent (离线安装)
- name: 创建 RKE2 配置目录
  file:
    path: "{{ rke2_config_dir }}"
    state: directory
    mode: '0755'

- name: 生成 RKE2 Agent 配置
  copy:
    dest: "{{ rke2_config_dir }}/config.yaml"
    content: |
      server: {{ rke2_api_server }}
      token: {{ hostvars['localhost']['rke2_node_token'] | default(rke2_token) }}
      write-kubeconfig-mode: "0644"
      selinux: false
    mode: '0600'

- name: 创建镜像加速配置
  copy:
    dest: "{{ rke2_config_dir }}/registries.yaml"
    content: |
      mirrors:
        docker.io:
          endpoint:
            - "https://docker.1ms.run"
            - "https://docker.m.daocloud.io"
            - "https://docker.nju.edu.cn"
        registry.k8s.io:
          endpoint:
            - "https://k8s.m.daocloud.io"
        ghcr.io:
          endpoint:
            - "https://ghcr.m.daocloud.io"
        quay.io:
          endpoint:
            - "https://quay.m.daocloud.io"
    mode: '0644'

- name: 检查 RKE2 是否已安装
  stat:
    path: /usr/local/bin/rke2
  register: rke2_installed

- name: 检查安装文件是否存在
  stat:
    path: /tmp/rke2.linux-amd64.tar.gz
  register: rke2_tarball

- name: 提示上传文件
  fail:
    msg: |
      请先上传 RKE2 安装文件到 /tmp/ 目录：
      scp rke2.linux-amd64.tar.gz caiqian@{{ ansible_host }}:/tmp/
      scp rke2-images.linux-amd64.tar.zst caiqian@{{ ansible_host }}:/tmp/
  when: not rke2_installed.stat.exists and not rke2_tarball.stat.exists

- name: 解压 RKE2 二进制文件
  unarchive:
    src: /tmp/rke2.linux-amd64.tar.gz
    dest: /usr/local
    remote_src: yes
  when: not rke2_installed.stat.exists

- name: 创建镜像目录
  file:
    path: /var/lib/rancher/rke2/agent/images
    state: directory
    mode: '0755'
  when: not rke2_installed.stat.exists

- name: 复制镜像文件
  copy:
    src: /tmp/rke2-images.linux-amd64.tar.zst
    dest: /var/lib/rancher/rke2/agent/images/
    remote_src: yes
  when: not rke2_installed.stat.exists

- name: 创建 systemd 服务文件
  copy:
    dest: /etc/systemd/system/rke2-agent.service
    content: |
      [Unit]
      Description=Rancher Kubernetes Engine v2 (agent)
      Documentation=https://github.com/rancher/rke2#readme
      Wants=network-online.target
      After=network-online.target
      
      [Service]
      Type=notify
      EnvironmentFile=-/etc/default/rke2-agent
      EnvironmentFile=-/etc/sysconfig/rke2-agent
      KillMode=process
      Delegate=yes
      LimitNOFILE=1048576
      LimitNPROC=infinity
      LimitCORE=infinity
      TasksMax=infinity
      TimeoutStartSec=0
      Restart=always
      RestartSec=5s
      ExecStartPre=-/sbin/modprobe br_netfilter
      ExecStartPre=-/sbin/modprobe overlay
      ExecStart=/usr/local/bin/rke2 agent
      
      [Install]
      WantedBy=multi-user.target
    mode: '0644'

- name: 启用 rke2-agent 服务
  systemd:
    name: rke2-agent
    enabled: yes
    daemon_reload: yes

- name: 启动 rke2-agent 服务
  systemd:
    name: rke2-agent
    state: started

- name: 等待 agent 就绪
  wait_for:
    timeout: 60

- name: 验证 Agent 连接
  shell: systemctl status rke2-agent
  register: agent_status
  changed_when: false

- name: 显示 Agent 状态
  debug:
    msg: "{{ agent_status.stdout_lines }}"

- name: Step 4 完成提示
  debug:
    msg: "✓ Step 4 完成 - RKE2 Agent 安装成功"
