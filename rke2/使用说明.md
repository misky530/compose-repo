# RKE2 分步骤部署 - 使用说明

## 下载和解压

```bash
# 解压项目
tar -xzf rke2-ansible-stepwise.tar.gz
cd rke2-ansible-stepwise
```

## 配置步骤

### 1. 修改主机清单

```bash
vim inventories/production/hosts
```

修改为你的实际 IP:
```ini
[rke2_servers]
rke2-master-01 ansible_host=你的Master_IP

[rke2_agents]
rke2-worker-01 ansible_host=你的Worker1_IP
rke2-worker-02 ansible_host=你的Worker2_IP
rke2-worker-03 ansible_host=你的Worker3_IP
```

### 2. 修改集群配置

```bash
vim inventories/production/group_vars/all.yml
```

**必须修改的参数:**
```yaml
# 生成新 token
rke2_token: "执行 openssl rand -hex 32 生成"

# 修改为你的 Master IP
rke2_api_server: "https://你的Master_IP:9345"
```

### 3. 配置 SSH 密钥

```bash
# 复制公钥到所有节点
ssh-copy-id caiqian@你的Master_IP
ssh-copy-id caiqian@你的Worker1_IP
ssh-copy-id caiqian@你的Worker2_IP
ssh-copy-id caiqian@你的Worker3_IP
```

## 部署方式

### 方式 1: 自动部署 (推荐)

```bash
# 测试连接
ansible rke2_cluster -m ping

# 开始部署
./deploy.sh
```

如果某步失败，可以从失败的步骤重新开始:
```bash
# 从 Step 2 重新开始
./deploy.sh --from-step 2

# 从 Step 3 重新开始
./deploy.sh --from-step 3
```

### 方式 2: 使用 Make

```bash
# 查看所有命令
make help

# 完整部署
make all

# 或分步执行
make step1  # Step 1: 初始化
make step2  # Step 2: 准备
make step3  # Step 3: Master
make step4  # Step 4: Worker

# 验证
make verify
```

### 方式 3: 手动逐步执行

```bash
# Step 1: 初始化环境
ansible-playbook playbooks/steps/step1-init-env.yml

# Step 2: 准备服务器
ansible-playbook playbooks/steps/step2-prepare-server.yml

# Step 3: 安装 Master
ansible-playbook playbooks/steps/step3-install-server.yml

# Step 4: 安装 Worker
ansible-playbook playbooks/steps/step4-install-agent.yml
```

## 验证集群

```bash
# 使用 playbook 验证
ansible-playbook playbooks/verify-cluster.yml

# 或直接登录 Master
ssh caiqian@你的Master_IP
sudo kubectl get nodes -o wide
sudo kubectl get pods -A
```

## 故障排查

### Step 失败了怎么办?

1. **查看详细日志**
```bash
ansible-playbook playbooks/steps/step2-prepare-server.yml -vvv
```

2. **单独重跑失败的步骤**
```bash
# 仅重跑 Step 2
ansible-playbook playbooks/steps/step2-prepare-server.yml

# 仅在某个节点重跑
ansible-playbook playbooks/steps/step2-prepare-server.yml --limit rke2-worker-01
```

3. **查看节点日志**
```bash
# Master 节点
ssh caiqian@Master_IP
sudo journalctl -u rke2-server -n 100 --no-pager

# Worker 节点
ssh caiqian@Worker_IP
sudo journalctl -u rke2-agent -n 100 --no-pager
```

### 常见问题

**问题 1: Step 1 连接失败**
```bash
# 解决方案
1. 检查 SSH 密钥: ssh caiqian@IP
2. 验证 inventory 中的 IP 正确
3. 确认用户名是 caiqian
```

**问题 2: Step 2 软件包安装失败**
```bash
# 解决方案
1. 检查网络连接
2. 更新 apt 源: sudo apt update
3. 手动安装失败的包
```

**问题 3: Step 3 Master 启动失败**
```bash
# 解决方案
1. 查看日志: sudo journalctl -u rke2-server -f
2. 检查配置: sudo cat /etc/rancher/rke2/config.yaml
3. 验证端口: sudo netstat -tulpn | grep 6443
```

**问题 4: Step 4 Worker 加入失败**
```bash
# 解决方案
1. 检查 token 是否正确
2. 测试连通性: telnet Master_IP 9345
3. 查看 Agent 日志: sudo journalctl -u rke2-agent -f
```

## 目录结构

```
rke2-ansible-stepwise/
├── ansible.cfg                     # Ansible 配置
├── inventories/                    # 主机清单
│   └── production/
│       ├── hosts                   # 主机列表 (需修改)
│       └── group_vars/
│           └── all.yml            # 全局变量 (需修改)
├── roles/                          # Ansible Roles
│   ├── step1-init-env/            # Step 1
│   ├── step2-prepare-server/      # Step 2
│   ├── step3-install-server/      # Step 3
│   └── step4-install-agent/       # Step 4
├── playbooks/                      # Playbook 文件
│   ├── steps/                     # 各步骤 playbook
│   └── verify-cluster.yml         # 验证脚本
├── deploy.sh                       # 主部署脚本
├── quickstart.sh                   # 快速开始向导
├── Makefile                        # Make 命令
└── README.md                       # 详细文档
```

## 卸载集群

```bash
make clean

# 或手动执行
ansible rke2_servers -m systemd -a "name=rke2-server state=stopped"
ansible rke2_agents -m systemd -a "name=rke2-agent state=stopped"
ansible rke2_cluster -m shell -a "/usr/bin/rke2-uninstall.sh"
```

## 项目特点

✓ **分步骤执行** - 问题定位快
✓ **失败可重跑** - 只需重跑失败步骤
✓ **详细日志** - 每步都有明确输出
✓ **Debian 优化** - 针对 Debian 系统优化
✓ **易于调试** - 支持单节点、单步骤执行

## 进阶用法

### 仅更新 Worker

```bash
# 添加新 Worker
vim inventories/production/hosts  # 添加新节点

# 仅部署新节点
ansible-playbook playbooks/steps/step1-init-env.yml --limit new-worker
ansible-playbook playbooks/steps/step2-prepare-server.yml --limit new-worker
ansible-playbook playbooks/steps/step4-install-agent.yml --limit new-worker
```

### 批量执行命令

```bash
# 在所有节点执行
ansible rke2_cluster -m shell -a "uptime"
ansible rke2_cluster -m shell -a "df -h"

# 仅在 Worker 执行
ansible rke2_agents -m shell -a "free -h"
```

## 下一步

部署完成后建议:
1. 配置持久化存储 (NFS/Longhorn)
2. 部署 Ingress Controller
3. 配置监控 (Prometheus + Grafana)
4. 实施备份策略

---

作者: Anthony
基于 15+ 年运维经验
